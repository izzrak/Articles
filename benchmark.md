# 深度学习主机性能测试

## 深度学习性能的影响因素
- 显卡性能：显卡性能主要由显卡构架，芯片型号，和实际频率决定。显卡构架越新，相同定位的显卡的深度学习性能越高，尤其是Nvidia的最新Volta构架，对于神经网络有着特殊的处理单元，大幅度提高神经网络的计算速度。不同型号的显卡，根据价格定位，计算能力和显存容量都存在着差异。由于深度学习的开发者和研究者预算充足，往往会选择高端型号的显卡用于计算。由于显卡存在公版(reference card)和非公版的差异，非公版的显卡的性能都会因显卡制造商的销售策略进行调整，例如对其进行超频，选用高级的元器件等来提升显卡计算能力，通常可以获得5%-15%的提升。
- 系统带宽：深度学习计算与挖矿程序在计算流程上相比具有很大的区别，由于神经网络在计算中，会保留大量中间结果用于计算反向传播的梯度值。又因为神经网络的训练通常使用非常庞大的数据集，因此无法将所有的中间值存储在显存中，训练框架需要频繁的对内存和显存中的数据进行交换，此时系统的带宽就极为重要。增大这部分带宽的主要方法有两种，一是使用高频高速内存，尽量选用双通道或者四通道甚至更多，提高数据的交换速度。其次要保证显卡的PCI-E接口工作在正确的模式。目前的显卡支持PCI-E 3.0的规范，正常的工作方式有16X，8X，4X和1X，不同模式下对显卡的针脚的利用率不同，从而实现不同速率的传输。为了保证显卡带宽达到最大值，应尽量保证PCI-E工作在16X模式下，即显卡接口拥有最大传输速率。通常情况下，内存传输为系统瓶颈，而当PCI-E工作在8X状态下则对性能影响不大。
- 读写性能：由于神经网络的训练选用的训练集数据往往比较庞大，在训练过程中会有高频率的数据读取，因此选择高速的固态硬盘能大幅度提升性能。

## 测试目的
对深度学习的主机进行性能测试，能判断主机的各个部件是否处于正常工作中，避免在训练过程中出现训练速度过慢，训练时显存溢出等问题。

## 测试方法
测试方法按照测试目的分为两种，第一种是使用常用模型进行测试，这种测试的优点在于用户对与该模型性能具有较深的理解，其在已有平台上的表现可以客观测量。使用该方法测试能较快的发现问题，但测试缺乏全面性，无法应对未知的错误。第二种就是使用专业工具进行测试，对深度学习中所运用到的绝大多数算法进行系统化的测试。该方法无需对模型足够了解，即可测试主机性能，适合服务器的运维人员。
### 使用实际模型进行测试
- 选用自己熟悉的框架：本机上常用tensorflow。
- 选择常用的模型：通过对Mobilenet-SSD模型进行训练，测试训练一批(batch)所需时间。
- 添加在代码中添加计时功能：可以统计多批的训练时间，取平均值，以缩小误差。
- 分别测试参考机和测试机，对比结果。

### 使用专业测试工具
[DeepBench](https://github.com/baidu-research/DeepBench) 是由百度研究院(Baidu Research)推出的一款针对不同的深度学习框架和运行库在不同的硬件平台的运行结果的测试软件。通过对不同的深度学习算法和运行库进行多方位的测试，帮助开发者和研究者判断自己平台的运算性能，从而制定合理的训练或开发策略。

#### 下载并编译
- 下载：git clone https://github.com/baidu-research/DeepBench
- 编译显卡测试代码：在code/nvidia目录下，修改Makefile中的运行库路径。
```makefile
ARCH:描述了显卡构架，pascal系列显卡的标识代码为sm_61
MPI_PATH: OpenMPI路径，如果使用apt install的方式安装，可以通过dpkg -L libopenmpi-dev查找储存路径。
CUDA_PATH: CUDA路径，通常在/usr/local/cuda下。
CUDNN_PATH: CuDNN路径. 储存路径取为安装时所复制到的路径，本机为/usr/local/cuda/lib64。
NCCL_PATH: NCCL路径. 如果使用apt install的方式安装，可以通过dpkg -L libnccl2查找储存路径。
NCCL_INCLUDE_PATH: nccl.h的储存路径，如果使用apt install的方式安装，可以通过dpkg -L libnccl-dev查找储存路径。
```
在配置完成后，检查Makefile中的文本代码，使用make进行编译，编译完成后的程序储存在code/nvidia/bin中。
编译好的程序一共有五个，分别为卷积测试程序conv_bench，矩阵运算库测试程序gemm_bench，显卡间通讯测试程序nccl_mpi_all_reduce以及nccl_single_all_reduce，循环神经网络测试程序rnn_bench。DeepBench提供了部分常用显卡的测试结果，可以在根目录中进行查看。
DeepBench还提供了AMD，Intel所支持的计算库，arm平台性能测试等功能，具体编译方式与显卡部分相同。结果同样可以在根目录下查看。
